stages:
  - build
  - test
  - deploy

harness:
  stage: build
  before_script:
    - docker info
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY/badarsebard/pyden-suite/pyden-harness:latest .
    - docker push $CI_REGISTRY/badarsebard/pyden-suite/pyden-harness:latest
  only:
    changes:
      - scripts/packages.sh
      - scripts/selenium.sh
      - Dockerfile
      - .gitlab-ci.yml

selenium:
  stage: test
  image: $CI_REGISTRY/badarsebard/pyden-suite/pyden-harness:latest
  script:
    - python3 test.py

appinspect:
  stage: test
  script:
    # first two lines are needed because when gitlab clones the repo it does so with a different set of permissions
    - find src -type d -exec chmod 0755 {} +
    - find src -type f -exec chmod 0644 {} +
    - tar -czvf pyden.tgz -C src pyden
    - tar -czvf pyden-manager.tgz -C src pyden-manager
    - scripts/submit-app.sh pyden
    - pyden_failures=$(echo $?)
    - scripts/submit-app.sh pyden-manager
    - manager_failures=$(echo $?)
    - x=$(( $pyden_failures + $manager_failures ))
    - if [[ $x -gt 0 ]]; then echo "There were $x failures in apps."; exit 1; fi
  artifacts:
    when: always
    paths:
      - pyden.html
      - pyden-manager.html
      - pyden.tgz
      - pyden-manager.tgz
  only:
    - tags
    - master

splunkbase:
  stage: deploy
  variables:
    SUPPORTED_VERSIONS: "7.2,7.3"
  script:
    - curl -u ${SPLUNK_CREDS} --request POST https://splunkbase.splunk.com/api/v1/app/4322/new_release/ -F "files[]=@pyden.tgz" -F "filename=pyden.tgz" -F "splunk_versions=${SUPPORTED_VERSIONS}" -F "visibility=true"
    - curl -u ${SPLUNK_CREDS} --request POST https://splunkbase.splunk.com/api/v1/app/4323/new_release/ -F "files[]=@pyden-manager.tgz" -F "filename=pyden-manager.tgz" -F "splunk_versions=${SUPPORTED_VERSIONS}" -F "visibility=true"
  only:
    - tags